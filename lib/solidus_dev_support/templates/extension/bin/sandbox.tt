#!/usr/bin/env bash

# Set the extension name
extension_name="<%= file_name %>"

set -e
test -z "${DEBUG+empty_string}" || set -x

test -n "$DB" || echo "~~~> Use 'export DB=[postgres|mysql|sqlite3]' to control the DB adapter"
# Support CircleCI runs in which DB is set to "sqlite" by the extension ORB.
test "$DB" = "sqlite" && export DB="sqlite3"
echo '~~~> Using $DB as the database engine'

test -n "$SOLIDUS_BRANCH" || echo "~~~> Use 'export SOLIDUS_BRANCH=[master|v3.2|...]' to control the Solidus branch"
echo '~~~> Using branch $SOLIDUS_BRANCH of solidus'

# Override bundle in order to stay away from the
# bundler env of the containing extension.
function with_unbundled_env {
  ruby -rbundler -e'Bundler.with_unbundled_env { system *ARGV }' -- $@
}

echo "~~~> Removing the old sandbox"
rm -rf ./sandbox

echo "~~~> Creating a pristine Rails app"
with_unbundled_env rails new sandbox \
  --database="$DB" \
  --skip-git \
  --skip-keeps \
  --skip-rc \
  --skip-spring \
  --skip-test \
  --skip-javascript

if [ ! -d "sandbox" ]; then
  echo 'sandbox rails application failed'
  exit 1
fi

cd ./sandbox

# Ensure any previous sandbox DB is recreated
bin/rails db:drop db:create

echo "~~~> Adding solidus to the Gemfile"
cat <<RUBY >> Gemfile
gem 'solidus', github: 'solidusio/solidus', branch: '$BRANCH'
gem 'pry-byebug', group: [:test, :development], platforms: [:mri]
RUBY

bundle config local.$extension_name "$PWD/.."
bundle config gemfile "$PWD/Gemfile"
with_unbundled_env bundle install

echo "~~~> Running the solidus:install generator"
with_unbundled_env bin/rails generate solidus:install --auto-accept $@

# If it's already in the bundle we can assume it was installed by solidus:install
(with_unbundled_env bundle list | grep --quiet $extension_name) || (
  echo "~~~> Installing the extension" &&
    with_unbundled_env bundle add $extension_name --path '..' &&
    with_unbundled_env ./bin/rails generate "${extension_name}:install" --auto-run-migrations
)

echo
echo "~~~> ğŸš€ Sandbox app successfully created for $extension_name!"
echo "~~~> ğŸ§ª This app is intended for test purposes."
